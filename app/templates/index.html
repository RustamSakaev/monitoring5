{% extends "base.html" %}

{% block styles %}
{{super()}}
<link rel="stylesheet" href="{{url_for('static', filename='js/leaflet-icon-pulse-master/dist/L.Icon.Pulse.css')}}">
<!--<link rel="stylesheet" href="{{url_for('static', filename='js/Leaflet.markercluster-1.4.1/dist/MarkerCluster.Default.css')}}">-->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css"
  integrity="sha512-M2wvCLH6DSRazYeZRIm1JnYyh22purTM+FDB5CsyxtQJYeKq83arPe5wgbNmcFXGqiSH2XR8dT/fJISVA1r/zQ=="
  crossorigin=""/>
<link rel="stylesheet" href="{{url_for('static', filename='js/Leaflet.markercluster-1.4.1/dist/MarkerCluster.css')}}">
<link rel="stylesheet" href="{{url_for('static', filename='js/leaflet-sidebar-v2-master/css/leaflet-sidebar.css')}}">
<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.css" integrity="sha256-IvM9nJf/b5l2RoebiFno92E5ONttVyaEEsdemDC6iQA=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/2.1.4/toastr.css" integrity="sha256-He3QEBKoL/nMXlVsoM7S2C2kjFQqS5L+mgA+F8LpG+U=" crossorigin="anonymous" />
{% endblock %}

{% block content %}
<div class="container">
    <!--<button class="getcoords">GET COORDINATES</button>-->
    <div class="row">
        <div id="mapdiv" class="col-lg-12">
            <div id="sidebar" class="leaflet-sidebar collapsed">
    <!-- Nav tabs -->
                <div class="leaflet-sidebar-tabs">
                    <ul  role="tablist"> <!-- top aligned tabs -->
                        <li id="incidents-tab"><a href="#incidents" role="tab"><i class="fa fa-bars"></i></a></li>
                        <li id="values-tab"><a href="#values" role="tab"><i class="fa fa-dashboard"></i></a></li>
                    </ul>

                    <ul role="tablist"> <!-- bottom aligned tabs -->
                        <li><a href="#settings" role="tab"><i class="fa fa-gear"></i></a></li>
                    </ul>
                </div>

                <!-- Tab panes -->
                <div class="leaflet-sidebar-content">
                    <div class="leaflet-sidebar-pane" id="incidents">
                        <h1 class="leaflet-sidebar-header">
                            Список аварий
                            <div class="leaflet-sidebar-close"><i class="fa fa-caret-left"></i></div>
                        </h1>
                        <table class="table">
                              <thead>
                                <tr>
                                  <th>Дата/время</th>
                                  <th>Адрес прибора</th>
                                  <th>Тип аварии</th>
                                    <th>Оценка</th>
                                </tr>
                              </thead>
                              <tbody class="incidentsbody">
                               {% for key,value in incidents.iterrows() %}

                                <tr  class=" {% if value['new']=='True' %}danger{% endif %}"  >
                                    <td>{{value["dateofvalue"]}}</td>
                                    <td><a href="#" class="clickable-address" data-coordinates="{{ value['coordinates'] }}" data-updated="{{value['updated_at']}}">{{value["address"]}}</a></td>
                                    <td>{{value["incident"]}}</td>
                                    <td>
                                        {% if value['true_class']=='None' %}
                                        <button class="like" title="Верно обнаруженная авария"  id="like-{{value['id']}}-{{value['class_of_incident_id']}}-{{value['true_class']}}">
                                            <i class="fa fa-thumbs-o-up" aria-hidden="true"></i>
                                        </button>
                                        <div class="dropdown">
                                        <button class="dislike dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true" title="Изменить класс показания" id="dislike-{{value['id']}}-{{value['class_of_incident_id']}}-{{value['true_class']}}">
                                            <i class="fa fa-thumbs-o-down" aria-hidden="true"></i>
                                        </button>
                                          <ul class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdownMenu1">
                                            <li><a class="change_class 5" href="#">Авария не наблюдается</a></li>
                                            <li><a class="change_class 1"  href="#">Утечка</a></li>
                                            <li><a class="change_class 2"  href="#">Прибор не передал показаний</a></li>
                                            <li><a class="change_class 3"  href="#">Порыв трубы</a></li>
                                            <li><a class="change_class 4" href="#">Незаконная врезка</a></li>
                                          </ul>
                                        </div>
                                        {% endif %}
                                        {% if value['true_class']==value['class_of_incident_id'] %}
                                        <button class="like" title="Верно обнаруженная авария" style="background-color: #BFFCC6;" id="like-{{value['id']}}-{{value['class_of_incident_id']}}-{{value['true_class']}}">
                                            <i class="fa fa-thumbs-o-up" aria-hidden="true"></i>
                                        </button>
                                         <div class="dropdown">
                                        <button class="dislike dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true" title="Изменить класс показания" id="dislike-{{value['id']}}-{{value['class_of_incident_id']}}-{{value['true_class']}}">
                                            <i class="fa fa-thumbs-o-down" aria-hidden="true"></i>
                                        </button>
                                          <ul class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdownMenu1">
                                            <li><a class="change_class 5" href="#">Авария не наблюдается</a></li>
                                            <li><a class="change_class 1" href="#">Утечка</a></li>
                                            <li><a class="change_class 2" href="#">Прибор не передал показаний</a></li>
                                            <li><a class="change_class 3" href="#">Порыв трубы</a></li>
                                            <li><a class="change_class 4" href="#">Незаконная врезка</a></li>
                                          </ul>
                                        </div>

                                        {% endif %}
                                        {% if value['true_class']!='None' and value['true_class']!=value['class_of_incident_id'] %}
                                        <button class="like" title="Верно обнаруженная авария" id="like-{{value['id']}}-{{value['class_of_incident_id']}}-{{value['true_class']}}">
                                            <i class="fa fa-thumbs-o-up" aria-hidden="true"></i>
                                        </button>
                                         <div class="dropdown">
                                        <button class="dislike dropdown-toggle " data-toggle="dropdown" aria-haspopup="true" aria-expanded="true" style="background-color: #FFABAB;" title="Изменить класс показания" id="dislike-{{value['id']}}-{{value['class_of_incident_id']}}-{{value['true_class']}}">
                                            <i class="fa fa-thumbs-o-down" aria-hidden="true"></i>
                                        </button>
                                          <ul class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdownMenu1">
                                            <li><a class="change_class 5 {% if value['true_class']=='5' %} active {% endif %}" style="{% if value['true_class']=='5'%} background-color: #99baee {% endif %}" href="#">Авария не наблюдается</a></li>
                                            <li><a class="change_class 1 {% if value['true_class']=='1' %} active {% endif %}" style="{% if value['true_class']=='1'%} background-color: #99baee {% endif %}" href="#">Утечка</a></li>
                                            <li><a class="change_class 2 {% if value['true_class']=='2' %} active {% endif %}" style="{% if value['true_class']=='2'%} background-color: #99baee {% endif %}" style="{% if value['true_class']=='2'%} background-color: #99baee {% endif %}" href="#">Прибор не передал показаний</a></li>
                                            <li><a class="change_class 3 {% if value['true_class']=='3' %} active {% endif %}" style="{% if value['true_class']=='3'%} background-color: #99baee {% endif %}" href="#">Порыв трубы</a></li>
                                            <li><a class="change_class 4 {% if value['true_class']=='4' %} active {% endif %}" style="{% if value['true_class']=='4'%} background-color: #99baee {% endif %}" href="#">Незаконная врезка</a></li>

                                          </ul>
                                        </div>
                                        {% endif %}
                                    </td>
                                </tr>
                               {% endfor %}
                              </tbody>
                            </table>
                    </div>

                    <div class="leaflet-sidebar-pane" id="values">
                        <h1 class="leaflet-sidebar-header">Информация о приборе<div class="leaflet-sidebar-close"><i class="fa fa-caret-left"></i></div></h1>

                        <ul class="nav nav-tabs">
                          <li id="table-li">
                            <a data-toggle="tab" href="#table">Таблица</a>
                          </li>
                          <li id="chart-li" class="active">
                            <a data-toggle="tab" href="#diagrams">Графики</a>
                          </li>
                        </ul>

                        <div class="tab-content">
                          <div class="tab-pane" id="table">
                              <div id="table_values"></div>
                          </div>

                          <div class="tab-pane active" id="diagrams">
                               <div class="form-group col-lg-6">
                                   <label>Выбор отображаемого показателя</label>
                                  <select class="form-control"  onchange="onChange()" id="indications">
                                      <option  value="p3">Давление</option>
                                      <option value="t3">Температура</option>
                                      <option selected value="v3">Объем</option>
                                </select>
                               </div>
                              <div class="form-group col-lg-6">
                                   <label style="margin-top:18px;">Период</label>
                                  <select class="form-control"  onchange="onChangePeriod()" id="period">
                                      <option value="6hour">За 6 часов</option>
                                      <option value="12hour">За 12 часов</option>
                                      <option selected value="24hour">За 24 часа</option>
                                      <option value="3day">За 3 дня</option>
                                      <option value="7day">За неделю</option>
                                      <option value="all">За все время</option>
                                </select>
                               </div>
                              <canvas id="myChart" width="400" height="400"></canvas>
                          </div>

                        </div>

                    </div>
                </div>
            </div>
            <div id="mapid"></div>
        </div>
        <!--<div id="infodiv" class="col-lg-4">
            <div class="row">
                 <div id="table_values">
                </div>
            </div>
           <div class="row">

           </div>
        </div>-->
    </div>

</div>


{% endblock %}

{% block scripts %}
<!--<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>-->
{{super()}}
<script src="{{url_for('static', filename='js/leaflet.js')}}"></script>
<script src="{{url_for('static', filename='js/Leaflet.markercluster-1.4.1/dist/leaflet.markercluster-src.js')}}"></script>
<script src="https://unpkg.com/@geoman-io/leaflet-geoman-free@latest/dist/leaflet-geoman.min.js"></script>
<!--<script src="{{url_for('static', filename='js/leaflet-geoman.min.js')}}"></script>-->
<script src="{{url_for('static', filename='js/Control.OSMGeocoder.js')}}"></script>
<script src="{{url_for('static', filename='js/leaflet-icon-pulse-master/dist/L.Icon.Pulse.js')}}"></script>
<script src="{{url_for('static', filename='js/leaflet-sidebar-v2-master/js/leaflet-sidebar.js')}}"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.bundle.js" integrity="sha256-8zyeSXm+yTvzUN1VgAOinFgaVFEFTyYzWShOy9w7WoQ=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/2.1.4/toastr.min.js" integrity="sha256-yNbKY1y6h2rbVcQtf0b8lq4a+xpktyFc3pSYoGAY1qQ=" crossorigin="anonymous"></script>
<script>


tiles=L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a rel="nofollow" href="http://osm.org/copyright">OpenStreetMap</a> contributors'
    });

var districts = L.layerGroup()
{% for district in districts %}
latlng={{district.coordinates}}
districts.addLayer(L.polygon(latlng, {color: 'green', weight:2,opacity:'75%',fillOpacity:'0.1'}).bindTooltip('{{district.name}}'))
{% endfor %}

var pipes=L.layerGroup()
{% for pipe in pipes %}
pipes.addLayer(L.polyline({{pipe.coordinates}},{className:'{{pipe.id}}'}).on('pm:edit', onEdit));
{% endfor %}



var map = L.map('mapid', {editable: true,layers: [tiles, districts,pipes]}).setView([57.153, 65.534], 13);


var overlayMaps = {
    "Районы": districts,
    "Трубы": pipes
};

L.control.layers(null,overlayMaps).addTo(map);

var sidebar = L.control.sidebar({
    autopan: false,       // whether to maintain the centered map point when opening the sidebar
    closeButton: true,    // whether t add a close button to the panes
    container: 'sidebar', // the DOM container or #ID of a predefined sidebar container that should be used
    position: 'left',     // left or right
}).addTo(map);




   map.pm.setLang('ru');
   map.pm.addControls({
        position: 'topleft',
        drawCircle: false,
        drawRectangle :false,
        drawCircleMarker: false,
        cutPolygon: false
    });


/*$(".clickable-address").click(function(){
    crd=$(this).data("coordinates");
    map.setView(crd.split(','), 18);
});*/

/*$("tbody").on("click", "button.dislike", function(){
     color=$(this).css('backgroundColor');
     console.log(color);
     row_id=$(this).attr('id').split('-')[1]
     inc_id=$(this).attr('id').split('-')[2]
     true_id=$(this).attr('id').split('-')[3]

     if (color=='rgb(240, 240, 240)'){
        $(this).css('background-color', '#FFABAB');
        $("#like-"+row_id+"-"+inc_id+"-"+true_id).css('background-color', 'rgb(240, 240, 240)');

        //dislike_new_id="dislike-"+row_id+"-"+inc_id+"-5";
        //like_new_id="like-"+row_id+"-"+inc_id+"-5";
        //$(this).attr("id",dislike_new_id);
        //$("#like-"+row_id+"-"+inc_id+"-"+true_id).attr("id",like_new_id);

         data={"id":row_id,"true_id":5}
          $.ajax(
            {
              type: 'POST',
              url: "/set_true_class",
              data:  data,
              dataType:'json',
              success: function(response)
              {
              },
              error: function(error) {
                console.log(error);
              }
            });
     }
     else{
        $(this).css('background-color', 'rgb(240, 240, 240)');

        //$(this).attr("id","dislike-"+row_id+"-"+inc_id+"-None");
        //$("#like-"+row_id+"-"+inc_id+"-"+true_id).attr("id","like-"+row_id+"-"+inc_id+"-None");

        data={"id":row_id,"true_id":"NULL"}
          $.ajax(
            {
              type: 'POST',
              url: "/set_true_class",
              data:  data,
              dataType:'json',
              success: function(response)
              {
              },
              error: function(error) {
                console.log(error);
              }
            });
     }
    console.log(data);
});*/

$("tbody").on("click", "a.change_class", function(){
    new_class=$(this).attr('class').split(' ')[1];
    console.log(new_class);

    color=$(this).parent().parent().parent().children(".dislike").css('background-color');
    x=$(this).parent().parent().find(".active");
    x.removeClass("active");
    x.css('background-color','white')

     row_id=$(this).parent().parent().parent().children(".dislike").attr('id').split('-')[1]
     inc_id=$(this).parent().parent().parent().children(".dislike").attr('id').split('-')[2]
     true_id=$(this).parent().parent().parent().children(".dislike").attr('id').split('-')[3]

     if (new_class==inc_id){

           $(this).parent().parent().parent().parent().find(".like").css('background-color', '#BFFCC6');
           $("#dislike-"+row_id+"-"+inc_id+"-"+true_id).css('background-color', 'rgb(240, 240, 240)');

            data={"id":row_id,"true_id":inc_id}
              $.ajax(
                {
                  type: 'POST',
                  url: "/set_true_class",
                  data:  data,
                  dataType:'json',
                  success: function(response)
                  {
                  },
                  error: function(error) {
                    console.log(error);
                  }
                });
     }
     else{
        $(this).css('background-color', '#99baee');
      $(this).addClass("active");

     if (color=='rgb(240, 240, 240)'){

        $(this).parent().parent().parent().children(".dislike").css('background-color', '#FFABAB');
        $("#like-"+row_id+"-"+inc_id+"-"+true_id).css('background-color', 'rgb(240, 240, 240)');

     }

      data={"id":row_id,"true_id":new_class}
          $.ajax(
            {
              type: 'POST',
              url: "/set_true_class",
              data:  data,
              dataType:'json',
              success: function(response)
              {
              },
              error: function(error) {
                console.log(error);
              }
            });
     }



});


$("tbody").on("click", "button.like", function(){
     color=$(this).css('backgroundColor');
     row_id=$(this).attr('id').split('-')[1]
     inc_id=$(this).attr('id').split('-')[2]
     true_id=$(this).attr('id').split('-')[3]


     if (color=='rgb(240, 240, 240)'){

           x=$(this).parent().find('active');
           x.removeClass("active");
           x.css('background-color', 'white');

           $(this).css('background-color', '#BFFCC6');
           $("#dislike-"+row_id+"-"+inc_id+"-"+true_id).css('background-color', 'rgb(240, 240, 240)');

            data={"id":row_id,"true_id":inc_id}
              $.ajax(
                {
                  type: 'POST',
                  url: "/set_true_class",
                  data:  data,
                  dataType:'json',
                  success: function(response)
                  {
                  },
                  error: function(error) {
                    console.log(error);
                  }
                });
     }
     else{
        $(this).css('background-color', 'rgb(240, 240, 240)');

        //$(this).attr("id","like-"+row_id+"-"+inc_id+"-None");
        //$("#dislike-"+row_id+"-"+inc_id+"-"+true_id).attr("id","dislike-"+row_id+"-"+inc_id+"-None");

        data={"id":row_id,"true_id":"NULL"}
          $.ajax(
            {
              type: 'POST',
              url: "/set_true_class",
              data:  data,
              dataType:'json',
              success: function(response)
              {
              },
              error: function(error) {
                console.log(error);
              }
            });
     }
    console.log(data);
});

$("#table_values").on("click", "button.like", function(){
       console.log('clickedclickedclicked');
     color=$(this).css('backgroundColor');
     row_id=$(this).attr('id').split('-')[1]
     inc_id=$(this).attr('id').split('-')[2]
     true_id=$(this).attr('id').split('-')[3]

     if (color=='rgb(240, 240, 240)'){

           //x=$(this).parent().find('active');
           //x.removeClass("active");
           //x.css('background-color', 'white');

           $(this).css('background-color', '#BFFCC6');
           //$("#dislike-"+row_id+"-"+inc_id+"-"+true_id).css('background-color', 'rgb(240, 240, 240)');

            data={"id":row_id,"true_id":inc_id}
              $.ajax(
                {
                  type: 'POST',
                  url: "/set_true_class",
                  data:  data,
                  dataType:'json',
                  success: function(response)
                  {
                  },
                  error: function(error) {
                    console.log(error);
                  }
                });
     }
     else{
        $(this).css('background-color', 'rgb(240, 240, 240)');

        //$(this).attr("id","like-"+row_id+"-"+inc_id+"-None");
        //$("#dislike-"+row_id+"-"+inc_id+"-"+true_id).attr("id","dislike-"+row_id+"-"+inc_id+"-None");

        data={"id":row_id,"true_id":"NULL"}
          $.ajax(
            {
              type: 'POST',
              url: "/set_true_class",
              data:  data,
              dataType:'json',
              success: function(response)
              {
              },
              error: function(error) {
                console.log(error);
              }
            });
     }
    console.log(data);
});



$('.incidentsbody').on('click', '.clickable-address', function() {
     crd=$(this).data("coordinates");
    map.setView(crd.split(','), 18);
});




var osmGeocoder = new L.Control.OSMGeocoder({bounds: L.latLngBounds(L.latLng(57.239079, 65.349162), L.latLng(57.051594, 65.838422)), placeholder: 'Введите адрес...', text: 'Поиск',}).addTo(map);
let map1 = new Map();

//создание объекта на карте
map.on('pm:create', e => {
  coordinates_raw=e.layer["_latlngs"];
  var coords = new Map();
  coordinates_raw.forEach(function(item, i, coordinates_raw) {
        coords.set(i,item["lat"]+","+item["lng"]);
   });
   data=JSON.stringify(mapToObj(coords));
            $.ajax(
            {
              type : 'POST',
              url : "/pipes",
              data    :  data,
              dataType:'json',
              success : function(data)
              {
              },
              error: function(error) {
                console.log(error);
            }
            });
});

 var dvcs = {{dvcs|tojson}};
    obj = JSON.parse(dvcs);
    console.log(obj);
    console.log(obj.length);

//получение координат через геокодер
$(".getcoords").click(function(){
    var coords = new Map();
    last = obj.length;
    obj.forEach(function(item, i, obj) {
    setTimeout(function(){
         address = item["address"]
         var url = osmGeocoder.geocode(address);
         var result = null;
         var x = new XMLHttpRequest();
         x.open("GET", url, true);
            x.onload = function (){
                    result=x.responseText;
                    if (result!=null){
                        if (x.responseText.length !=0){
                             result = JSON.parse(result)
                             if (result[0]["osm_type"]=="node"){
                                 coordinates=result[0]["lat"]+","+result[0]["lon"];
                                 coords.set(address,coordinates);
                             }
                        }
                  }
            }
        x.send(null);
        if (i==(last-1)){
            console.log(coords);
            data=JSON.stringify(mapToObj(coords));
            console.log(data);
            /*$.ajax(
            {
              type : 'POST',
              url : "/coordinates",
              data    :  data,
              dataType:'json',
              success : function(data)
              {

              },
              error: function(error) {
                console.log(error);
            }
            });*/
        }
    },1800*(i+1));
});
});

const mapToObj = m => {
  return Array.from(m).reduce((obj, [key, value]) => {
    obj[key] = value;
    return obj;
  }, {});
};

map.on('pm:remove', e => {
 if (e.layer.options["title"]){
    data={"address":e.layer.options["title"],"type":"device"}
 }
 else{
    data={"ID":e.layer.options["className"],"type":"pipe"}
 }
  $.ajax(
    {
      type: 'POST',
      url: "/remove",
      data:  data,
      dataType:'json',
      success: function(response)
      {
      },
      error: function(error) {
        console.log(error);
      }
    });

});


const customIcon = L.divIcon({
    className: 'device',
    html: '<div class="devicestyle"></div>',
    iconSize:[30,30],
    iconAnchor:[15,15]
});


var pulsingIcon = L.icon.pulse({
    iconSize:[30,30],
    color:'red'
    });

//инициализация плагина для кластеризации маркеров
var markers = L.markerClusterGroup(
{showCoverageOnHover:false,
spiderfyOnMaxZoom:false,
disableClusteringAtZoom: 17,
iconCreateFunction: function(cluster) {
		var children = cluster.getAllChildMarkers();
		className="device";
		animate=false;
		a=[];
        children.forEach(function(item, i, children) {
                     if (typeof(item.options.icon.options.color) != "undefined" && item.options.icon.options.color !== null){
                        className="danger";
                        animate=true;
                     }
         });
		return L.icon.pulse({
                html:  '<div class="devicestyle"><b>' + cluster.getChildCount() + '</b></div>',
                animate: animate,
                iconSize:[30,30],
                iconAnchor:[15,15],
                color:'red'
                });
	}}
);
{% for device in devices %}
markers.addLayer(L.marker([{{device.coordinates}}],{icon: customIcon, title:'{{device.address}}',alt:'{{device.id}}'}).on('click', onClick).on('dragend',onEdit));
//.addTo(map)

{% endfor %}
map.addLayer(markers);


ids=[]
true_class=[]
{% for key,value in incidents.iterrows() %}
ids.push({{value["device_id"]}});
{% endfor %}



marks=markers.pm._layers;
marks.forEach(function(item, i, marks) {
       if (ids.indexOf(Number(item.options["alt"]))!=-1){
            item.options["icon"]=pulsingIcon;
            markers.refreshClusters([item]);
       }
});


function onEdit(e){
    console.log(e);
    if (e.type == "dragend")
       data={"type":"Device","id":e.target.options["alt"],"coords":e.target._latlng["lat"]+";"+e.target._latlng["lng"]};
    else{
        crd=e.target._latlngs;
        crd_string="[";
        crd.forEach(function(item, i, crd) {
            crd_string+="["+item["lat"]+";"+item["lng"]+"]";
            if (i!=crd.length-1)
                crd_string+=";";
       });
        crd_string+="]";
        data={"type":"Pipe","id":e.target.options["className"],"coords":crd_string};
    }
       console.log(data);
     $.ajax(
            {
              type: 'POST',
              url: "/update_coordinates",
              data:  data,
              dataType:'json',
              success: function(response)
              {
              },
              error: function(error) {
                console.log(error);
              }
            });
}

dateofvalue=[];
    T3=[];
    V3=[];
    P3=[];

max_id="";
device_id="";
//клик по маркеру
function onClick(e) {
    console.log("начальные данные")
    id=e['target']['options']['alt']
    device_id=id;
    data={"period":"24hour","id":id,"is_first_load":"true","max_id":""};
    console.log(data);
    sidebar.open('values');
    $.ajax(
            {
              type : 'POST',
              url : "/base",
              data    :  data,
              dataType:'json',
              success : function(data)
              {
                console.log('response'+data.length);
               if (data.length!=0){

                console.log(data);
                sidebar.open('values');
                $("#table_values").empty()
                $("#table_values").append('<div class="col-lg-6"><h2>'+data[0]["address"]+'</h2></div>');
                 $("#table_values").append('<div class="form-group col-lg-6">\
                                   <label style="margin-top:18px;">Период</label>\
                                  <select class="form-control"  onchange="onChangePeriodTable()" id="periodTable">\
                                      <option  value="6hour">За 6 часов</option>\
                                      <option value="12hour">За 12 часов</option>\
                                      <option selected value="24hour">За 24 часа</option>\
                                      <option  value="3day">За 3 дня</option>\
                                      <option value="7day">За неделю</option>\
                                      <option value="all">За все время</option>\
                                </select>\
                               </div>');

                $("#table_values").append('<table class="table table-hover">\
                    <thead>\
                        <tr>\
                            <th>Дата/время показаний</th>\
                            <th>Давление, кПа</th>\
                            <th>Температура, °С</th>\
                            <th>Объем, м³</th>\
                            <th>Класс</th>\
                            <th>Оценка</th>\
                        </tr>\
                    </thead>\
                    <tbody id="tablevalues" class="body-of-table">\
                    </tbody>\
                    </table>');
                dateofvalue=[];
                        T3=[];
                        P3=[];
                        V3=[];
                max_id=data[0]["id"];
                console.log('max_id='+max_id);
                data.forEach(function(item, i, data) {
                        dateofvalue.push(new Date(item['dateofvalue']));
                        T3.push(item['temperature']);
                        P3.push(item['pressure']);
                        V3.push(item['volume']);
                        if (item['class_of_incident_id']!=5){
                         $('.body-of-table').append('<tr  data-updated="'+item["updated_at"]+'" class="danger indicaton-row">\
                            <td>'+item['dateofvalue']+'</td>\
                                <td>'+item['pressure']+'</td>\
                                <td>'+item['temperature']+'</td>\
                                <td>'+item['volume']+'</td>\
                                <td>'+item['incident']+'</td>\
                                <td class="buttons_indications'+item["id"]+'"></td>\
                            </tr>');
                         }
                         else{
                         $('.body-of-table').append('<tr class="indicaton-row" data-updated="'+item["updated_at"]+'>\
                                <td>'+item['dateofvalue']+'</td>\
                                <td>'+item['pressure']+'</td>\
                                <td>'+item['temperature']+'</td>\
                                <td>'+item['volume']+'</td>\
                                <td>'+item['incident']+'</td>\
                                <td class="buttons_indications'+item["id"]+'"></td>\
                            </tr>');
                         }

                         if (item['true_class']=='None'){
                            $(".buttons_indications"+item['id']).append('<button class="like" title="Верно обнаруженная авария"  id="like-'+item["id"]+'-'+item['class_of_incident_id']+'-'+item['true_class']+'">\
                             <i class="fa fa-thumbs-o-up" aria-hidden="true"></i>\
                            </button>\
                            <button class="dislike" title="Авария на приборе не наблюдается" id="dislike-'+item["id"]+'-'+item["class_of_incident_id"]+'-'+item['true_class']+'">\
                                <i class="fa fa-thumbs-o-down" aria-hidden="true"></i>\
                            </button>');
                          }
                         if (item['true_class']==item['class_of_incident_id']){
                             $('.buttons_indications'+item['id']).append('<button class="like" title="Верно обнаруженная авария"  style="background-color: #BFFCC6;" id="like-'+item["id"]+'-'+item['class_of_incident_id']+'-'+item['true_class']+'">\
                             <i class="fa fa-thumbs-o-up" aria-hidden="true"></i>\
                            </button>\
                            <button class="dislike" title="Авария на приборе не наблюдается" id="dislike-'+item["id"]+'-'+item["class_of_incident_id"]+'-'+item['true_class']+'">\
                                <i class="fa fa-thumbs-o-down" aria-hidden="true"></i>\
                            </button>');
                         }
                         if (item['true_class']!='None' && item['true_class']!=item['class_of_incident_id']){
                          $('.buttons_indications'+item['id']).append('<button class="like" title="Верно обнаруженная авария"  id="like-'+item["id"]+'-'+item['class_of_incident_id']+'-'+item['true_class']+'">\
                             <i class="fa fa-thumbs-o-up" aria-hidden="true"></i>\
                            </button>\
                            <button class="dislike" title="Авария на приборе не наблюдается" style="background-color: #FFABAB;" id="dislike-'+item["id"]+'-'+item["class_of_incident_id"]+'-'+item['true_class']+'">\
                                <i class="fa fa-thumbs-o-down" aria-hidden="true"></i>\
                            </button>');
                         }

                 });


                value=document.getElementById("indications").value;
                label=getLabelAndArray(value)[0];
                d=getLabelAndArray(value)[1];
                drawDiagram(dateofvalue,label,d);
               }
              },
              error: function(error) {
                console.log(error);
            }
            });
}


var myChart;
function drawDiagram(dateofvalue, label,d){

                if (typeof window.myChart != 'undefined'){
                    //window.myChart.destroy();
                    $('#myChart').remove();
                    $('#diagrams').append('<canvas id="myChart" width="400" height="400"></canvas>');
                    console.log('redrawing chart');
                }

                var ctx = document.getElementById('myChart').getContext('2d');
                myChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: dateofvalue,
                        datasets: [{
                            label: label,
                            data: d,
                            backgroundColor:'rgba(136, 159, 242, 1)',
                            pointBackgroundColor:'rgba(0, 116, 217, 1)'
                        }]
                    },
                    options: {
                        responsive: false,
                        legend: {
                          display: false
                          },
                        scales: {
                            yAxes: [{
                                ticks: {
                                    beginAtZero: true
                                },
                                scaleLabel: {
                                    display: true,
                                    labelString: label
                                }
                            }],
                            xAxes: [{
                                type: "time",
                              time: {
                                    unit: 'hour',
                                    unitStepSize: 1,
                                    round: 'hour',
                                    tooltipFormat: "DD-MM-YYYY HH:mm",
                                    displayFormats: {
                                      hour: 'HH:mm'
                                    }
                               },
                                scaleLabel: {
                                    display: true,
                                    labelString: "Дата/время"
                                }
                            }],

                        }
                    }
                });

}

function getPeriodLabel(value){
    period="";
    switch (value) {
      case "6hour":
        period="6hour";
        break;
      case "12hour":
        period="12hour";
        break;
      case "24hour":
        period="24hour";
        break;
      case "3day":
        period="3day";
        break;
      case "7day":
        period="7day";
        break;
      case "all":
        period="all";
        break;
    }
    return period;
}

function onChangePeriodTable() {
    value=document.getElementById("periodTable").value;
    period=getPeriodLabel(value);

    id=device_id;
    data={"period":period,"id":id,"is_first_load":"false","max_id":""};
    console.log(data);
    $.ajax(
            {
              type : 'POST',
              url : "/base",
              data    :  data,
              dataType:'json',
              success : function(data)
              {
              console.log('response '+data.length);
               if (data.length!=0){
                 updateBodyOfIndicationsTable(data);
               }
              },
              error: function(error) {
                console.log(error);
            }
            });
}


function onChangePeriod() {
    value=document.getElementById("period").value;
    period=getPeriodLabel(value);

    id=device_id;
    data={"period":period,"id":id,"is_first_load":"false","max_id":""};
    console.log(data);
    $.ajax(
            {
              type : 'POST',
              url : "/base",
              data    :  data,
              dataType:'json',
              success : function(data)
              {
               console.log('response '+data.length);
               if (data.length!=0){
                        dateofvalue=[];
                        T3=[];
                        P3=[];
                        V3=[];
                data.forEach(function(item, i, data) {
                        dateofvalue.push(new Date(item['dateofvalue']));
                        T3.push(item['temperature']);
                        P3.push(item['pressure']);
                        V3.push(item['volume']);
                 });

                value=document.getElementById("indications").value;
                label=getLabelAndArray(value)[0];
                d=getLabelAndArray(value)[1];
                drawDiagram(dateofvalue,label,d);
               }
              },
              error: function(error) {
                console.log(error);
            }
            });
}

function getLabelAndArray(value){
    label="";
    d="";
    switch (value) {
      case "t3":
        label="Температура, °С"
        d=T3;
        break;
      case "p3":
        label="Давление, кПа"
        d=P3;
        break;
      case "v3":
        label="Объем,м³";
        d=V3;
        break;
    }
    result=[];
    result.push(label);
    result.push(d);
    return result;
}

function onChange() {
    value=document.getElementById("indications").value;
    label=getLabelAndArray(value)[0];
    d=getLabelAndArray(value)[1];
    drawDiagram(dateofvalue,label,d);
    /*myChart.data.datasets = [d];
    myChart.update();
    console.log("updating");*/

}

function updateBodyOfIndicationsTable(data){
        $("#tablevalues").html('');
        max_id=data[0]["id"];
        data.forEach(function(item, i, data) {
             if (item['class_of_incident_id']==1){

             $('.body-of-table').append('<tr  data-updated="'+item["updated_at"]+'" class="danger indicaton-row">\
                    <td>'+item['dateofvalue']+'</td>\
                    <td>'+item['pressure']+'</td>\
                    <td>'+item['temperature']+'</td> \
                    <td>'+item['volume']+'</td>\
                    <td>'+item['incident']+'</td>\
                    <td class="buttons_indications'+item["id"]+'"></td>\
                </tr>');
            }
            else{
            $('.body-of-table').append('<tr  data-updated="'+item["updated_at"]+'" class="indicaton-row">\
                    <td>'+item['dateofvalue']+'</td>\
                    <td>'+item['pressure']+'</td>\
                    <td>'+item['temperature']+'</td>\
                    <td>'+item['volume']+'</td>\
                    <td>'+item['incident']+'</td>\
                    <td class="buttons_indications'+item["id"]+'"></td>\
                </tr>');
            }

             if (item['true_class']=='None'){
                $(".buttons_indications"+item['id']).append('<button class="like" title="Верно обнаруженная авария"  id="like-'+item["id"]+'-'+item['class_of_incident_id']+'-'+item['true_class']+'">\
                 <i class="fa fa-thumbs-o-up" aria-hidden="true"></i>\
                </button>\
                <button class="dislike" title="Авария на приборе не наблюдается" id="dislike-'+item["id"]+'-'+item["class_of_incident_id"]+'-'+item['true_class']+'">\
                    <i class="fa fa-thumbs-o-down" aria-hidden="true"></i>\
                </button>');
              }
             if (item['true_class']==item['class_of_incident_id']){
                 $('.buttons_indications'+item['id']).append('<button class="like" title="Верно обнаруженная авария"  style="background-color: #BFFCC6;" id="like-'+item["id"]+'-'+item['class_of_incident_id']+'-'+item['true_class']+'">\
                 <i class="fa fa-thumbs-o-up" aria-hidden="true"></i>\
                </button>\
                <button class="dislike" title="Авария на приборе не наблюдается" id="dislike-'+item["id"]+'-'+item["class_of_incident_id"]+'-'+item['true_class']+'">\
                    <i class="fa fa-thumbs-o-down" aria-hidden="true"></i>\
                </button>');
             }
             if (item['true_class']!='None' && item['true_class']!=item['class_of_incident_id']){
              $('.buttons_indications'+item['id']).append('<button class="like" title="Верно обнаруженная авария"  id="like-'+item["id"]+'-'+item['class_of_incident_id']+'-'+item['true_class']+'">\
                 <i class="fa fa-thumbs-o-up" aria-hidden="true"></i>\
                </button>\
                <button class="dislike" title="Авария на приборе не наблюдается" style="background-color: #FFABAB;" id="dislike-'+item["id"]+'-'+item["class_of_incident_id"]+'-'+item['true_class']+'">\
                    <i class="fa fa-thumbs-o-down" aria-hidden="true"></i>\
                </button>');
             }
         });



}

  /*$("#table_values").on("click", "#close", function() {
        $("#table_values").empty()
        $('#infodiv').css('display','none');
        $("#mapdiv").attr('class', 'col-lg-12');
    });


    function show(e) {
        $('#infodiv').css('display','block');
        $("#mapdiv").attr('class', 'col-lg-8');
    }*/

maxdate=""
function updateIndications(){
    value=document.getElementById("periodTable").value;
    period=getPeriodLabel(value);
    id=device_id;

    dates=[]
    $(".indicaton-row").each(function(){
        if ($(this).data("updated")!="None"){
             dates.push(new Date($(this).data("updated")));
        }

    });
    dates.sort(function(a, b){return b - a});
    maxdate=dates[0]
    console.log(dates);



    data={"period":period,"id":id,"is_first_load":"false","max_id":max_id,"max_date":maxdate};
    console.log(data);
    $.ajax(
            {
              type: 'POST',
              url: "/base",
              dataType:'json',
              data: data,
              success: function(data)
              {
                console.log('updateIndications');
                console.log('response '+data.length);
                if (data.length!=0){
                    console.log('redraw table');
                    updateBodyOfIndicationsTable(data);
               }
               console.log('nothing');
              },
              complete: function() {
                    if (doLoop==true){
                        setTimeout(updateIndications, 10*1000);
                    }
                },
              error: function(error) {
                console.log(error);
              }
            });
}

function updateCharts(){
    console.log('updatingCharts');
    value=document.getElementById("period").value;
    period=getPeriodLabel(value);
    id=device_id;
    data={"period":period,"id":id,"is_first_load":"false","max_id":max_id};
    console.log(data);
    $.ajax(
            {
              type: 'POST',
              url: "/base",
              dataType:'json',
              data: data,
              success: function(data)
              {
                //console.log('response '+data.length);
                if (data.length!=0){

                    //console.log(data);
                    dateofvalue=[];
                    T3=[];
                    P3=[];
                    V3=[];
                    max_id=data[0]["id"];
                    data.forEach(function(item, i, data) {
                        dateofvalue.push(new Date(item['dateofvalue']));
                        T3.push(item['temperature']);
                        P3.push(item['pressure']);
                        V3.push(item['volume']);
                     });

                    value=document.getElementById("indications").value;
                    label=getLabelAndArray(value)[0];
                    d=getLabelAndArray(value)[1];
                    drawDiagram(dateofvalue,label,d);
               }

              },
              complete: function() {
                    if (doLoop==true){
                        setTimeout(updateCharts, 10*1000);
                    }
                },
              error: function(error) {
                console.log(error);
              }
            });
}

var max_updated_at={{max_updated_at|tojson}};
max_updated_at=new Date(max_updated_at);

function getDateString(){

    var todayDate = new Date();
    var currYear = todayDate.getFullYear();
    var currMonth = todayDate.getMonth()+1;
    var currDay = todayDate.getDate();
    var currHour = todayDate.getHours();
    var currMinute = todayDate.getMinutes();

    if (currDay<10)
        currDay="0"+currDay.toString();
    if (currHour<10)
        currHour="0"+currHour.toString();
    if (currMinute<10)
        currMinute="0"+currMinute.toString();

    switch (currMonth)
        {
          case 1: fMonth="января"; break;
          case 2: fMonth="февраля"; break;
          case 3: fMonth="марта"; break;
          case 4: fMonth="апреля"; break;
          case 5: fMonth="мая"; break;
          case 6: fMonth="июня"; break;
          case 7: fMonth="июля"; break;
          case 8: fMonth="августа"; break;
          case 9: fMonth="сентября"; break;
          case 10: fMonth="октября"; break;
          case 11: fMonth="ноября"; break;
          case 12: fMonth="декабря"; break;
        }
    now=(currDay + " " + fMonth + " " + currYear+" "+currHour+":"+currMinute);
    return now;
}


function updateIncidentsTable(){

    toastr.options = {
     "closeButton": true,
     "positionClass": "toast-bottom-right",
     "timeOut": "0",
     "extendedTimeOut": "0",
      "preventDuplicates": true
    }

    sidebar_state=$("#sidebar").attr('class');
    sidebar_closed=sidebar_state.toString().includes('collapsed');
    incidents_state=$("#incidents").attr('class');
    is_incidents_active=incidents_state.toString().includes('active');

    //console.log('old '+max_updated_at);
    dates=$(".clickable-address").length;

    let incidents_ids = new Map();
    let inc_ids=new Map();
     $('.dislike').each(function(i, obj){
        row_id=$(obj).attr('id').split('-')[1]
        inc_id=$(obj).attr('id').split('-')[2]
        true_id=$(obj).attr('id').split('-')[3]
        incidents_ids.set(row_id,true_id);
        inc_ids.set(row_id,inc_id);
    });

    data={"max_date":max_updated_at.toString(),"rows":JSON.stringify(Object.fromEntries(incidents_ids))};
    console.log(data);
    $.ajax(
            {
              type: 'POST',
              url: "/new_incidents",
              dataType:'json',
              data: data,
              success: function(data)
              {
                toastr.error('Обнаружено 3 новых нештатных ситуации<br><br><a class="toast-link" href="#">К списку аварий</a>',"4 мая 2020 19:02");
                console.log('length of data= '+data.length);

                //console.log(data);
                console.log(data['need_update']);
                console.log(data['true_class']);



                if (data['need_update']!==undefined && data['need_update']=='True'){
                    /*let db_ids = new Map();
                    true_responce=data['true_class'];
                    for (let key in true_responce) {
                        db_ids.set(key,true_responce[key][0]);
                    }
                    var site_ids_sorted = new Map([...incidents_ids.entries()].sort());
                    var site_inc_sorted = new Map([...inc_ids.entries()].sort());
                    for (let [k, v] of site_ids_sorted) {
                            if (db_ids[k]!=v){
                                $("#dislike-"+k+"-"+site_ids_sorted[k]+"-"+);
                            }
                    }*/
                    d=JSON.parse("[" + data['data'] + "]");
                    d=d[0];
                    $(".incidentsbody").html('');
                    d.forEach(function(item, i, d) {
                         if (item['new']=="True"){
                             $('.incidentsbody').append('<tr class="danger">\
                                    <td>'+item["dateofvalue"]+'</td>\
                                    <td><a href="#" class="clickable-address" data-coordinates="'+item["coordinates"]+'" data-updated="'+item["updated_at"]+'">'+item["address"]+'</a></td>\
                                     <td>'+item["incident"]+'</td>\
                                     <td class="buttons'+item["id"]+'"></td>\
                                </tr>');
                            }
                            else{
                            $('.incidentsbody').append('<tr>\
                                    <td>'+item["dateofvalue"]+'</td>\
                                    <td><a href="#" class="clickable-address" data-coordinates="'+item['coordinates']+'" data-updated="'+item['updated_at']+'">'+item["address"]+'</a></td>\
                                    <td>'+item["incident"]+'</td>\
                                    <td class="buttons'+item["id"]+'"></td>\
                                </tr>');
                            }
                          if (item['true_class']=='None'){
                            $(".buttons"+item['id']).append('<button class="like" title="Верно обнаруженная авария"  id="like-'+item["id"]+'-'+item['class_of_incident_id']+'-'+item['true_class']+'">\
                             <i class="fa fa-thumbs-o-up" aria-hidden="true"></i>\
                            </button>\
                            <div class="dropdown">\
                            <button class="dislike dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true" title="Изменить тип аварии" id="dislike-'+item["id"]+'-'+item["class_of_incident_id"]+'-'+item['true_class']+'">\
                                <i class="fa fa-thumbs-o-down" aria-hidden="true"></i>\
                            </button>\
                              <ul class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdownMenu1">\
                                <li><a class="change_class 5 "'+item["id"]+' href="#">Авария не наблюдается</a></li>\
                                <li><a class="change_class 1 "'+item["id"]+' href="#">Утечка</a></li>\
                                <li><a class="change_class 2 "'+item["id"]+' href="#">Прибор не передал показаний</a></li>\
                                <li><a class="change_class 3 "'+item["id"]+' href="#">Порыв трубы</a></li>\
                                <li><a class="change_class 4 "'+item["id"]+' href="#">Незаконная врезка</a></li>\
                              </ul>\
                            </div>');
                          }

                         if (item['true_class']==item['class_of_incident_id']){
                             $('.buttons'+item['id']).append('<button class="like" title="Верно обнаруженная авария"  style="background-color: #BFFCC6;" id="like-'+item["id"]+'-'+item['class_of_incident_id']+'-'+item['true_class']+'">\
                             <i class="fa fa-thumbs-o-up" aria-hidden="true"></i>\
                            </button>\
                            <div class="dropdown">\
                            <button class="dislike dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true" title="Изменить тип аварии" id="dislike-'+item["id"]+'-'+item["class_of_incident_id"]+'-'+item['true_class']+'">\
                                <i class="fa fa-thumbs-o-down" aria-hidden="true"></i>\
                            </button>\
                              <ul class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdownMenu1">\
                                <li><a class="change_class 5 "'+item["id"]+' href="#">Авария не наблюдается</a></li>\
                                <li><a class="change_class 1 "'+item["id"]+' href="#">Утечка</a></li>\
                                <li><a class="change_class 2 "'+item["id"]+' href="#">Прибор не передал показаний</a></li>\
                                <li><a class="change_class 3 "'+item["id"]+' href="#">Порыв трубы</a></li>\
                                <li><a class="change_class 4 "'+item["id"]+' href="#">Незаконная врезка</a></li>\
                              </ul>\
                            </div>');
                         }
                         if (item['true_class']!='None' && item['true_class']!=item['class_of_incident_id']){
                          $('.buttons'+item['id']).append('<button class="like" title="Верно обнаруженная авария"  id="like-'+item["id"]+'-'+item['class_of_incident_id']+'-'+item['true_class']+'">\
                             <i class="fa fa-thumbs-o-up" aria-hidden="true"></i>\
                            </button>\
                            <div class="dropdown">\
                            <button class="dislike dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true" style="background-color: #FFABAB"; title="Изменить тип аварии" id="dislike-'+item["id"]+'-'+item["class_of_incident_id"]+'-'+item['true_class']+'">\
                                <i class="fa fa-thumbs-o-down" aria-hidden="true"></i>\
                            </button>\
                              <ul class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdownMenu1">\
                                <li><a class="change_class 5 "'+item["id"]+' href="#">Авария не наблюдается</a></li>\
                                <li><a class="change_class 1 "'+item["id"]+' href="#">Утечка</a></li>\
                                <li><a class="change_class 2 "'+item["id"]+' href="#">Прибор не передал показаний</a></li>\
                                <li><a class="change_class 3 "'+item["id"]+' href="#">Порыв трубы</a></li>\
                                <li><a class="change_class 4 "'+item["id"]+' href="#">Незаконная врезка</a></li>\
                              </ul>\
                            </div>');
                          $('.change_class '+item['true_id']+' '+item['id']).addClass('active').css('background-color', '#99baee');
                         }
                    });
                }

                if (data['need_update']===undefined && data.length!=0 && data.length!=dates.length){
                    console.log('i am updated');
                    max_updated_at=new Date(data[0]['max_updated_at'])
                    //console.log('new '+max_updated_at);

                    new_ids=[]
                    //console.log('updateIncidentsTable');
                    //console.log(data);


                    $(".incidentsbody").html('');
                    data.forEach(function(item, i, data) {
                         new_ids.push(Number(item["device_id"]));
                         if (item['new']=="True"){
                             $('.incidentsbody').append('<tr class="danger">\
                                    <td>'+item["dateofvalue"]+'</td>\
                                    <td><a href="#" class="clickable-address" data-coordinates="'+item["coordinates"]+'" data-updated="'+item["updated_at"]+'">'+item["address"]+'</a></td>\
                                     <td>'+item["incident"]+'</td>\
                                     <td class="buttons'+item["id"]+'"></td>\
                                </tr>');
                            }
                            else{
                            $('.incidentsbody').append('<tr>\
                                    <td>'+item["dateofvalue"]+'</td>\
                                    <td><a href="#" class="clickable-address" data-coordinates="'+item['coordinates']+'" data-updated="'+item['updated_at']+'">'+item["address"]+'</a></td>\
                                    <td>'+item["incident"]+'</td>\
                                    <td class="buttons'+item["id"]+'"></td>\
                                </tr>');
                            }
                          if (item['true_class']=='None'){
                            $(".buttons"+item['id']).append('<button class="like" title="Верно обнаруженная авария"  id="like-'+item["id"]+'-'+item['class_of_incident_id']+'">\
                             <i class="fa fa-thumbs-o-up" aria-hidden="true"></i>\
                            </button>\
                            <div class="dropdown">\
                            <button class="dislike dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true" title="Изменить тип аварии" id="dislike-'+item["id"]+'-'+item["class_of_incident_id"]+'-'+item['true_class']+'">\
                                <i class="fa fa-thumbs-o-down" aria-hidden="true"></i>\
                            </button>\
                              <ul class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdownMenu1">\
                                <li><a class="change_class 5 "'+item["id"]+' href="#">Авария не наблюдается</a></li>\
                                <li><a class="change_class 1 "'+item["id"]+' href="#">Утечка</a></li>\
                                <li><a class="change_class 2 "'+item["id"]+' href="#">Прибор не передал показаний</a></li>\
                                <li><a class="change_class 3 "'+item["id"]+' href="#">Порыв трубы</a></li>\
                                <li><a class="change_class 4 "'+item["id"]+' href="#">Незаконная врезка</a></li>\
                              </ul>\
                            </div>');
                          }
                         if (item['true_class']==item['class_of_incident_id']){
                             $('.buttons'+item['id']).append('<button class="like" title="Верно обнаруженная авария"  style="background-color: #BFFCC6;" id="like-'+item["id"]+'-'+item['class_of_incident_id']+'">\
                             <i class="fa fa-thumbs-o-up" aria-hidden="true"></i>\
                            </button>\
                            <div class="dropdown">\
                            <button class="dislike dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true" title="Изменить тип аварии" id="dislike-'+item["id"]+'-'+item["class_of_incident_id"]+'-'+item['true_class']+'">\
                                <i class="fa fa-thumbs-o-down" aria-hidden="true"></i>\
                            </button>\
                              <ul class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdownMenu1">\
                                <li><a class="change_class 5 "'+item["id"]+' href="#">Авария не наблюдается</a></li>\
                                <li><a class="change_class 1 "'+item["id"]+' href="#">Утечка</a></li>\
                                <li><a class="change_class 2 "'+item["id"]+' href="#">Прибор не передал показаний</a></li>\
                                <li><a class="change_class 3 "'+item["id"]+' href="#">Порыв трубы</a></li>\
                                <li><a class="change_class 4 "'+item["id"]+' href="#">Незаконная врезка</a></li>\
                              </ul>\
                            </div>');
                         }
                         if (item['true_class']!='None' && item['true_class']!=item['class_of_incident_id']){
                          $('.buttons'+item['id']).append('<button class="like" title="Верно обнаруженная авария"  id="like-'+item["id"]+'-'+item['class_of_incident_id']+'">\
                             <i class="fa fa-thumbs-o-up" aria-hidden="true"></i>\
                            </button>\
                            <div class="dropdown">\
                            <button class="dislike dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true"  style="background-color: #FFABAB"; title="Изменить тип аварии" id="dislike-'+item["id"]+'-'+item["class_of_incident_id"]+'-'+item['true_class']+'">\
                                <i class="fa fa-thumbs-o-down" aria-hidden="true"></i>\
                            </button>\
                              <ul class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdownMenu1">\
                                <li><a class="change_class 5 "'+item["id"]+' href="#">Авария не наблюдается</a></li>\
                                <li><a class="change_class 1 "'+item["id"]+' href="#">Утечка</a></li>\
                                <li><a class="change_class 2 "'+item["id"]+' href="#">Прибор не передал показаний</a></li>\
                                <li><a class="change_class 3 "'+item["id"]+' href="#">Порыв трубы</a></li>\
                                <li><a class="change_class 4 "'+item["id"]+' href="#">Незаконная врезка</a></li>\
                              </ul>\
                            </div>');
                          $('.change_class '+item['true_id']+' '+item['id']).addClass('active').css('background-color', '#99baee');
                         }
                    });

                    if (data.length!=dates.length){
                            new_incidents=0;
                            console.log(ids);
                            console.log(new_ids);
                            new_ids.forEach(function(item, i, new_ids) {
                               if(ids.indexOf(item)==-1){
                                    console.log('as new '+item);
                                   new_incidents=new_incidents+1;
                               }
                            });

                            if (new_incidents!=0){
                                if (sidebar_closed){
                                    date=getDateString()
                                    toastr.error('Обнаружено '+new_incidents+' новых нештатных ситуации<br><br><a class="toast-link" href="#">К списку аварий</a>',date);
                                }
                                else if(!is_incidents_active){
                                     date=getDateString()
                                    toastr.error('Обнаружено '+data.length+' новых нештатных ситуации<br><br><a class="toast-link" href="#">К списку аварий</a>',date);
                                }
                            }

                            //console.log(ids);
                            //console.log(new_ids);

                            marks.forEach(function(item, i, marks) {
                                   if (ids.indexOf(Number(item.options["alt"]))!=-1){
                                        item.options["icon"]=customIcon;
                                        markers.refreshClusters([item]);
                                   }
                                   if (new_ids.indexOf(Number(item.options["alt"]))!=-1){
                                        item.options["icon"]=pulsingIcon;
                                        markers.refreshClusters([item]);
                                   }
                            });
                            ids=new_ids;
                            //console.log('done');
                            }
               }


              },
              complete: function() {
                        setTimeout(updateIncidentsTable, 10*1000);
                },
              error: function(error) {
                console.log(error);
              }
            });
};


$('body').on('click', '.toast-link', function() {
     toastr.clear();
     sidebar.open('incidents');
});

function startLoop(){
    doLoop=true;
}

$('#table-li').click(function(){
     doLoop=false;
     setTimeout(startLoop, 10*1000);
     setTimeout(updateIndications, 11*1000);
});

$('#chart-li').click(function(){
     doLoop=false;
     setTimeout(startLoop, 10*1000);
     setTimeout(updateCharts, 11*1000);
});

$('#incidents-tab').click(function(){
     doLoop=false;
});

$('#values-tab').click(function(){
     doLoop=false;
     setTimeout(startLoop, 10*1000);
     table_tab=$('#table').attr('class');
            chart_tab=$('#diagrams').attr('class');
            table_tab=table_tab.toString().includes('active');
            chart_tab=chart_tab.toString().includes('active');
            if (chart_tab==true){
                 setTimeout(updateCharts, 11*1000);
            }
            else if (table_tab==true){
                setTimeout(updateIndications, 11*1000);
            }
});

doLoop=false;
sidebar.on('opening', function(e) {
        doLoop=false;

        val_class=$('#values').attr('class');
        val_class=val_class.toString().includes('active');
        if (val_class==true){
             doLoop=true;
            console.log('charts');
            chart_tab=$('#diagrams').attr('class');
            chart_tab=chart_tab.toString().includes('active');
            if (chart_tab==true){
                updateCharts();
            }
        }

    });

sidebar.on('closing', function(e) {
        doLoop=false;
    });




$(document).ready(function() {
     setTimeout(updateIncidentsTable, 10*1000);

  /*setTimeout(updateIncidentsTable, 10*1000);
  setTimeout(updateIndications, 10*1000);
  setTimeout(updateCharts, 10*1000);*/
});



/*let markindist = new Map();
marks=markers.pm._layers;
console.log('marks');
console.log(marks);

dists=districts._layers;
console.log('districts');


var dis = Object.keys(dists).map(function(key) {
  return dists[key];
});

marks.forEach(function(mark, i, marks) {
       dis.forEach(function(dist, j, dis) {
               is_inside=isMarkerInsidePolygon(mark, dist);
               console.log(is_inside)
               if (is_inside){
                    console.log('i am true');
                    markindist.set(mark.options["alt"], dist._tooltip._content);
                    return;
               }
        });
});
console.log(markindist);*/


function isMarkerInsidePolygon(marker, poly) {
    var polyPoints = poly.getLatLngs();

    var x = marker.getLatLng().lat, y = marker.getLatLng().lng;

    var inside = false;
    for (var i = 0, j = polyPoints.length - 1; i < polyPoints.length; j = i++) {
        var xi = polyPoints[i].lat, yi = polyPoints[i].lng;
        var xj = polyPoints[j].lat, yj = polyPoints[j].lng;

        var intersect = ((yi > y) != (yj > y))
            && (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
        if (intersect) inside = !inside;
    }

    return inside;
};

</script>

{% endblock %}


